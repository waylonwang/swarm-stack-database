version: "3.4"

services:
  # Mariadb 10
  mariadb:
    image: mariadb:latest
    networks:
      - network_cluster       
    restart: always
    environment:
      # 直接使用Portainer容器内的环境变量
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
    volumes:
      - nfs_mariadb_data:/var/lib/mysql
      - nfs_mariadb_conf:/etc/mysql/conf.d
      - nfs_mariadb_log:/var/log/mysql
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.mariadb.rule=HostSNI(`mysql.${DOMAIN_SWARM}`)"
        - "traefik.http.routers.mariadb.entrypoints=mariadb"
        - "traefik.http.routers.mariadb.service=mariadb"
        - "traefik.http.routers.mariadb.middlewares=noauth-chain@file"
        - "traefik.http.services.mariadb.loadbalancer.server.port=3306"       
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.type == vm 
          - node.labels.database == true

  # Phpmyadmin
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    networks:
      - network_cluster       
    restart: on-failure
    environment:
      # 直接使用Portainer容器内的环境变量
      PMA_ARBITRARY: ${PMA_ARBITRARY}
      PMA_HOSTS: ${PMA_HOSTS}
      PMA_VERBOSES: ${PMA_VERBOSES}
      PMA_PORTS: ${PMA_PORTS}
      PMA_USER: ${PMA_USER}
      PMA_PASSWORD: ${PMA_PASSWORD}
    volumes:
      - nfs_phpmyadmin:/var/www/html/themes/mytheme  
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.phpmyadmin.rule=Host(`mysqladmin.${DOMAIN_SWARM}`)"
        - "traefik.http.routers.phpmyadmin.entrypoints=websecure"
        - "traefik.http.routers.phpmyadmin.service=phpmyadmin"
        - "traefik.http.routers.phpmyadmin.middlewares=noauth-chain@file"
        - "traefik.http.services.phpmyadmin.loadbalancer.server.port=80"       
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.type == vm 
          - node.labels.database == true

networks:
  network_cluster:
    external: true

x-common-keys-volume: &common-keys-volume
  type: nfs
  o: addr=${NFS_SERVER},rw,nfsvers=4
  
volumes:
 # NFS
  nfs_mariadb_data: 
    driver: local
    driver_opts:
      <<: *common-keys-volume
      device: :${NFS_DEVICE}/database/mysql/mariadb10/data
  nfs_mariadb_conf: 
    driver: local
    driver_opts:
      <<: *common-keys-volume
      device: :${NFS_DEVICE}/database/mysql/mariadb10/conf
  nfs_mariadb_log: 
    driver: local
    driver_opts:
      <<: *common-keys-volume
      device: :${NFS_DEVICE}/database/mysql/mariadb10/log
  nfs_phpmyadmin: 
    driver: local
    driver_opts:
      <<: *common-keys-volume
      device: :${NFS_DEVICE}/database/phpmyadmin/theme