---
# Update Time: 2024-09-01 12:02
version: "3.4"

x-defines:
  service-common: &service-common-ref
    networks: [network_cluster]
    restart: on-failure
  env-common: &env-common-ref
    NO_PROXY: ${NO_PROXY:-localhost,127.0.0.1,::1}
    TZ: ${TZ:-Asia/Shanghai}    
  env-proxy: &env-proxy-ref
    HTTP_PROXY: ${OPENCLASH_HTTP_PROXY}
    HTTPS_PROXY: ${OPENCLASH_HTTP_PROXY}
    http_proxy: ${OPENCLASH_HTTP_PROXY}
    https_proxy: ${OPENCLASH_HTTP_PROXY}
  deploy-common: &deploy-common-ref
    mode: replicated
    replicas: 1
    restart_policy:
      condition: on-failure
      delay: 5s      
  placement-default: &placement-default-ref
    placement:
      constraints:
        - node.labels.type == vm
        - node.labels.database == true
  driver-common: &driver-common-ref
    type: nfs
    o: addr=${NFS_SERVER},rw,nfsvers=4

services:
  # ------------------------------------------------------------
  # Mariadb 10
  # ------------------------------------------------------------
  mariadb:
    <<: *service-common-ref
    # image-ref: library/mariadb:11.4.2
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/library/mariadb:11.4.2
    environment:
      <<: *env-common-ref
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
    volumes:
      - nfs_mariadb_data:/var/lib/mysql
      - nfs_mariadb_conf:/etc/mysql/conf.d
      - nfs_mariadb_log:/var/log/mysql
    logging:
      driver: fluentd
      options:
        tag: docker.database.mariadb
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.tcp.routers.mariadb.rule=HostSNI(`*`)
        - traefik.tcp.routers.mariadb.entrypoints=mariadb
        - traefik.tcp.routers.mariadb.service=mariadb
        - traefik.tcp.services.mariadb.loadbalancer.server.port=3306
        - homepage.group=Database & Development
        - homepage.name=MySQL
        - homepage.icon=mysql.png
        - homepage.description=Mariadb 10数据库(11.4.2)
        - homepage.href=https://mysqladmin.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        - homepage.ping=mariadb
        - homepage.siteMonitor=http://phpmyadmin:80
        - homepage.weight=20
      <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # Phpmyadmin
  # ------------------------------------------------------------
  phpmyadmin:
    <<: *service-common-ref
    # image-ref: library/phpmyadmin:5.2.1
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/library/phpmyadmin:5.2.1
    environment:
      <<: *env-common-ref
      PMA_ARBITRARY: ${PMA_ARBITRARY}
      PMA_HOSTS: ${PMA_HOSTS}
      PMA_VERBOSES: ${PMA_VERBOSES}
      PMA_PORTS: ${PMA_PORTS}
      PMA_USER: ${PMA_USER}
      PMA_PASSWORD: ${PMA_PASSWORD}
    volumes:
      - nfs_phpmyadmin:/var/www/html/themes/mytheme
    logging:
      driver: fluentd
      options:
        tag: docker.database.phpmyadmin
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.phpmyadmin.rule=Host(`mysqladmin.${DOMAIN_SWARM}`,`mysqladmin.${DOMAIN_EMERGENCY}`)
        - traefik.http.routers.phpmyadmin.entrypoints=websecure
        - traefik.http.routers.phpmyadmin.service=phpmyadmin
        - traefik.http.routers.phpmyadmin.middlewares=auth,normal-chain@file
        - traefik.http.services.phpmyadmin.loadbalancer.server.port=80
        # - homepage.group=Database & Development
        # - homepage.name=MySQL Admin
        # - homepage.icon=mysql.png
        # - homepage.href=https://mysqladmin.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        # - homepage.description=MySQL管理
        # - homepage.siteMonitor=http://phpmyadmin:80
        # - homepage.weight=11
      <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # Postgres 14
  # ------------------------------------------------------------
  postgres:
    <<: *service-common-ref
    # image-ref: library/postgres:14.7
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/library/postgres:14.7
    command: >
      /bin/bash -c "
        # 启动 PostgreSQL 容器
        /usr/local/bin/docker-entrypoint.sh postgres &

        # 等待 PostgreSQL 启动
        until pg_isready -h localhost -p 5432; do
          echo 'Waiting for PostgreSQL to start...'
          sleep 2
        done

        # 安装 pgAgent
        # apt-get update && apt-get install -y pgagent &&

        # 启动 pgAgent 守护进程
        pgagent -f -l 2 hostaddr=localhost dbname=$${POSTGRES_DB} port=5432 user=$${POSTGRES_USER} password=$${POSTGRES_PASSWORD}

        # 使用 exec 保证容器一直运行
        wait $$!"
    environment:
      <<: *env-common-ref
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USER}
      PGDATA: ${PGDATA}
    volumes:
      - nfs_postgres_data:${PGDATA}
      - nfs_postgres_extension:/usr/share/postgresql/14/extension
    logging:
      driver: fluentd
      options:
        tag: docker.database.postgres
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.tcp.routers.postgres.rule=HostSNI(`*`)
        - traefik.tcp.routers.postgres.entrypoints=postgres
        - traefik.tcp.routers.postgres.service=postgres
        - traefik.tcp.services.postgres.loadbalancer.server.port=5432
        - homepage.group=Database & Development
        - homepage.name=PostgreSQL
        - homepage.icon=postgres.png
        - homepage.description=PostgreSQL 14数据库(14.7)
        - homepage.href=https://pgadmin.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        - homepage.ping=postgres
        - homepage.siteMonitor=http://pgadmin
        - homepage.weight=22
      <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # pgagent
  # ------------------------------------------------------------
  # pgagent:
  #   <<: *service-common-ref
  #   # image-ref: chiavegatto/postgres-pgagent:14.1
  #   image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/chiavegatto/postgres-pgagent:14.1
  #   depends_on:
  #     - postgres    
  #   # entrypoint: /bin/sh -c
  #   #             "/tmp/wait-for-it.sh postgres:5432 --timeout=30 &&
  #   #             PGPASSWORD='${POSTGRES_PASSWORD}' psql -U ${POSTGRES_USER} -h postgres -p 5432 -d ${POSTGRES_DB} -c 'CREATE EXTENSION IF NOT EXISTS pgagent;' &&
  #   #             pgagent hostaddr=postgres dbname=${POSTGRES_DB} user=${POSTGRES_USER} port=5432 password=${POSTGRES_PASSWORD}"
  #   entrypoint: >
  #     /bin/sh -c "
  #     until pg_isready -h postgres -p 5432; do sleep 2; done;
  #     pgagent -f hostaddr=postgres dbname=${POSTGRES_DB} user=${POSTGRES_USER} port=5432 password=${POSTGRES_PASSWORD};
  #     tail -f /dev/null"                
  #   environment:
  #     <<: *env-common-ref                
  #   logging:
  #     driver: fluentd
  #     options:
  #       tag: docker.database.pgagent
  #       fluentd-async-connect: "true"                
  #   deploy:
  #     # <<: [*deploy-common-ref, *placement-default-ref]
  #     mode: replicated
  #     replicas: 1
  #     restart_policy:
  #       condition: none  
  #     placement:
  #       constraints:
  #         - node.labels.type == vm
  #         - node.labels.database == true          

  # ------------------------------------------------------------
  # Postgres Vector
  # ------------------------------------------------------------
  pgvector:
    <<: *service-common-ref
    # image: ankane/pgvector:v0.5.0
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/ankane/pgvector:v0.5.0
    environment:
      <<: *env-common-ref
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USER}
      PGDATA: ${PGDATA}
    volumes:
      - nfs_pgvector:${PGDATA}
    logging:
      driver: fluentd
      options:
        tag: docker.database.pgvector
        fluentd-async-connect: "true"
    deploy:
      labels:
        # - traefik.enable=true
        # - traefik.tcp.routers.pgvector.rule=HostSNI(`*`)
        # - traefik.tcp.routers.pgvector.entrypoints=pgvector
        # - traefik.tcp.routers.pgvector.service=pgvector
        # - traefik.tcp.services.pgvector.loadbalancer.server.port=5432
        - homepage.group=Database & Development
        - homepage.name=PGVector
        - homepage.icon=postgres.png
        - homepage.description=PostgreSQL Vector数据库(0.5)
        - homepage.ping=pgvector
        - homepage.weight=23
      <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # Pgadmin
  # ------------------------------------------------------------
  pgadmin:
    <<: *service-common-ref
    # image-ref: dpage/pgadmin4:8.6
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/dpage/pgadmin4:8.6
    environment:
      <<: *env-common-ref
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
    volumes:
      - nfs_pgadmin_data:/var/lib/pgadmin
      - nfs_pgadmin_src:/pgadmin4
    logging:
      driver: fluentd
      options:
        tag: docker.database.pgadmin
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.pgadmin.rule=Host(`pgadmin.${DOMAIN_SWARM}`,`pgadmin.${DOMAIN_EMERGENCY}`)
        - traefik.http.routers.pgadmin.entrypoints=websecure
        - traefik.http.routers.pgadmin.service=pgadmin
        - traefik.http.routers.pgadmin.middlewares=auth,normal-chain@file
        - traefik.http.services.pgadmin.loadbalancer.server.port=80
        # - homepage.group=Database & Development
        # - homepage.name=PostgreSQL Admin
        # - homepage.icon=postgres.png
        # - homepage.href=https://pgadmin.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        # - homepage.description=PostgreSQL管理
        # - homepage.siteMonitor=http://pgadmin
        # - homepage.weight=14
      <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # Mongo 5
  # ------------------------------------------------------------
  mongo:
    <<: *service-common-ref
    # image-ref: library/mongo:5.0.27
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/library/mongo:5.0.27
    ports:
      - "27017:27017"
    environment:
      <<: *env-common-ref
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    volumes:
      - nfs_mongo_data_db:/data/db
      - nfs_mongo_data_configdb:/data/configdb
      - nfs_mongo_config:/etc/mongo
    logging:
      driver: fluentd
      options:
        tag: docker.database.mongo
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.tcp.routers.mongo.rule=HostSNI(`*`)
        - traefik.tcp.routers.mongo.entrypoints=mongo
        - traefik.tcp.routers.mongo.service=mongo
        - traefik.tcp.services.mongo.loadbalancer.server.port=27017
        - homepage.group=Database & Development
        - homepage.name=MongoDB
        - homepage.icon=mongodb.png
        - homepage.description=MongoDB 5数据库(5.0.27)
        - homepage.href=https://mongoadmin.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        - homepage.ping=mongo
        - homepage.siteMonitor=http://mongoadmin:8081
        - homepage.weight=25
      <<: [*deploy-common-ref, *placement-default-ref]

  mongo-fastgpt:
    <<: *service-common-ref
    # image-ref: library/mongo:5.0.27
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/library/mongo:5.0.27
    command: mongod --keyFile /data/mongodb.key --replSet rs0
    entrypoint:
      - bash
      - -c
      - |
        openssl rand -base64 128 > /data/mongodb.key
        chmod 400 /data/mongodb.key
        chown 999:999 /data/mongodb.key
        echo 'const isInited = rs.status().ok === 1
        if(!isInited){
          rs.initiate({
              _id: "rs0",
              members: [
                  { _id: 0, host: "mongo-fastgpt:27017" }
              ]
          })
        }' > /data/initReplicaSet.js
        # 启动MongoDB服务
        exec docker-entrypoint.sh "$$@" &

        # 等待MongoDB服务启动
        until mongo -u ${MONGO_USER} -p ${MONGO_PASSWORD} --authenticationDatabase admin --eval "print('waited for connection')" > /dev/null 2>&1; do
          echo "Waiting for MongoDB to start..."
          sleep 2
        done

        # 执行初始化副本集的脚本
        mongo -u ${MONGO_USER} -p ${MONGO_PASSWORD} --authenticationDatabase admin /data/initReplicaSet.js

        # 等待docker-entrypoint.sh脚本执行的MongoDB服务进程
        wait $$!    
    ports:
      - "27018:27017"
    environment:
      <<: *env-common-ref
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    volumes:
      - nfs_mongo-fastgpt_data_db:/data/db
    logging:
      driver: fluentd
      options:
        tag: docker.database.mong-fastgpto
        fluentd-async-connect: "true"
    deploy:
      <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # Mongo-Express
  # ------------------------------------------------------------
  mongoadmin:
    <<: *service-common-ref
    # image-ref: library/mongo-express:0.49.0
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/library/mongo-express:0.49.0
    environment:
      <<: *env-common-ref
      ME_CONFIG_OPTIONS_EDITORTHEME: ${ME_CONFIG_OPTIONS_EDITORTHEME}
      ME_CONFIG_MONGODB_ENABLE_ADMIN: ${ME_CONFIG_MONGODB_ENABLE_ADMIN}
      ME_CONFIG_MONGODB_SERVER: ${ME_CONFIG_MONGODB_SERVER}
      ME_CONFIG_MONGODB_PORT: ${ME_CONFIG_MONGODB_PORT}
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${ME_CONFIG_MONGODB_ADMINUSERNAME}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${ME_CONFIG_MONGODB_ADMINPASSWORD}
      # ME_CONFIG_BASICAUTH_USERNAME: ${ME_CONFIG_BASICAUTH_USERNAME}
      # ME_CONFIG_BASICAUTH_PASSWORD: ${ME_CONFIG_BASICAUTH_PASSWORD}
      ME_CONFIG_MONGODB_URL: ${ME_CONFIG_MONGODB_URL}
    logging:
      driver: fluentd
      options:
        tag: docker.database.mongoadmin
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.mongoadmin.rule=Host(`mongoadmin.${DOMAIN_SWARM}`,`mongoadmin.${DOMAIN_EMERGENCY}`)
        - traefik.http.routers.mongoadmin.entrypoints=websecure
        - traefik.http.routers.mongoadmin.service=mongoadmin
        - traefik.http.routers.mongoadmin.middlewares=auth,normal-chain@file
        - traefik.http.services.mongoadmin.loadbalancer.server.port=8081
        # - homepage.group=Database & Development
        # - homepage.name=MongoDB Admin
        # - homepage.icon=mongodb.png
        # - homepage.href=https://mongoadmin.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        # - homepage.description=MongoDB管理
        # - homepage.siteMonitor=http://mongoadmin:8081
        # - homepage.weight=16
      <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # Redis
  # ------------------------------------------------------------
  redis:
    <<: *service-common-ref
    # image-ref: library/redis:7.2.5
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/library/redis:7.2.5
    command: redis-server /etc/redis/redis.conf
    ports:
      - "6379:6379"
    environment:
      <<: *env-common-ref
    volumes:
      - nfs_redis_data:/data
      - nfs_redis_config:/etc/redis
    logging:
      driver: fluentd
      options:
        tag: docker.database.redis
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.tcp.routers.redis.rule=HostSNI(`*`)
        - traefik.tcp.routers.redis.entrypoints=redis
        - traefik.tcp.routers.redis.service=redis
        - traefik.tcp.services.redis.loadbalancer.server.port=6379      
        - homepage.group=Database & Development
        - homepage.name=Redis
        - homepage.icon=redis.png
        - homepage.description=Redis数据库(7.2.5)
        - homepage.href=https://redisui.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        - homepage.ping=redis
        - homepage.siteMonitor=http://redisui:7843
        - homepage.weight=27
      <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # Redis UI
  # ------------------------------------------------------------
  redisui:
    <<: *service-common-ref
    # image-ref: patrikx3/p3x-redis-ui:2024.4.329
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/patrikx3/p3x-redis-ui:2024.4.329
    environment:
      <<: *env-common-ref
    volumes:
        - nfs_redis_ui:/settings
    logging:
      driver: fluentd
      options:
        tag: docker.database.redisui
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.redisui.rule=Host(`redisui.${DOMAIN_SWARM}`,`redisui.${DOMAIN_EMERGENCY}`)
        - traefik.http.routers.redisui.entrypoints=websecure
        - traefik.http.routers.redisui.service=redisui
        - traefik.http.routers.redisui.middlewares=auth,normal-chain@file
        - traefik.http.services.redisui.loadbalancer.server.port=7843
        # - homepage.group=Database & Development
        # - homepage.name=Redis UI
        # - homepage.icon=redis.png
        # - homepage.href=https://redisui.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        # - homepage.description=Redis管理
        # - homepage.siteMonitor=http://redisui:7843
        # - homepage.weight=18
      <<: [*deploy-common-ref, *placement-default-ref]

networks:
  network_cluster:
    external: true

volumes:
  # NFS
  nfs_mariadb_data:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/mysql/mariadb10/data
  nfs_mariadb_conf:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/mysql/mariadb10/conf
  nfs_mariadb_log:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/mysql/mariadb10/log
  nfs_phpmyadmin:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/phpmyadmin/theme
  nfs_postgres_data:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/postgres/data
  nfs_postgres_extension:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/postgres/extension
  nfs_pgvector:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/pgvector/data
  nfs_pgadmin_data:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/pgadmin/data
  nfs_pgadmin_src:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/pgadmin/src
  nfs_mongo_data_db:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/mongo/data/db
  nfs_mongo_data_configdb:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/mongo/data/configdb
  nfs_mongo_config:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/mongo/config
  nfs_mongo-fastgpt_data_db:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/mongo-fastgpt/data/db
  nfs_redis_data:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/redis/data
  nfs_redis_config:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/redis/config
  nfs_redis_ui:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/database/redisui
...